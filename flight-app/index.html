<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightFinder Pro | Ultimate Booking Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .modal-active { overflow: hidden; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.8s cubic-bezier(0, 1, 0, 1); }
        .details-content.open { max-height: 1200px; transition: max-height 1s ease-in-out; }
        
        :root {
            --brand-blue: #1e3a8a; 
            --brand-accent: #f59e0b; 
            --bg-solid: #f1f5f9; 
            --text-dark: #0f172a; 
        }
        body { background-color: var(--bg-solid); color: var(--text-dark); }
        .bg-brand-solid { background-color: var(--brand-blue); }
        .btn-brand-solid { background-color: var(--brand-blue); transition: background-color 0.2s; }
        .btn-brand-solid:hover { background-color: #172554; } 
        .btn-accent-solid { background-color: var(--brand-accent); color: white; }
        
        /* FIX: Autocomplete Suggestions visibility */
        .suggestions { z-index: 9999 !important; position: absolute; width: 100%; top: 100%; left: 0; }

        .seat { width: 30px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; cursor: pointer; transition: all 0.2s; }
        .seat-avail { background: #e2e8f0; border: 2px solid #cbd5e1; color: #64748b; }
        .seat-occupied { background: #fee2e2; border: 2px solid #fecaca; color: #ef4444; opacity: 0.6; }
        .seat-premium { background: #fef3c7; border: 2px solid #fcd34d; color: #b45309; }

        @keyframes progress { from { width: 0%; } to { width: 100%; } }
    </style>
</head>
<body class="font-sans" onload="loadFeaturedDeals()">

    <nav class="bg-brand-solid p-5 shadow-xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <h1 onclick="goHome()" class="text-2xl font-black text-white cursor-pointer flex items-center tracking-tighter">
                <i class="fa-solid fa-paper-plane mr-3 text-amber-400"></i>FlightFinder
            </h1>
            <div class="hidden md:block bg-white/10 text-blue-100 text-[10px] font-black px-4 py-2 rounded-md uppercase border border-white/20 tracking-widest">Global Live API Active</div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto p-4 mt-10">
        <div id="search-card" class="bg-white p-10 rounded-[2rem] shadow-xl border-2 border-slate-200 mb-8 transition-all">
            <div class="flex flex-wrap items-center gap-4 mb-8">
                <select id="tripType" onchange="toggleInputs()" class="bg-blue-100 text-blue-800 px-6 py-3 rounded-xl text-xs font-black outline-none border-none cursor-pointer">
                    <option value="one-way">ONE WAY</option>
                    <option value="round-trip">ROUND TRIP</option>
                </select>
                <select id="travelClass" class="bg-slate-100 text-slate-700 px-6 py-3 rounded-xl text-xs font-black outline-none border-none cursor-pointer">
                    <option value="ECONOMY">ECONOMY</option>
                    <option value="BUSINESS">BUSINESS</option>
                </select>
                <div class="flex items-center bg-emerald-100 text-emerald-800 px-6 py-3 rounded-xl gap-4 font-black">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px]">ADULTS</span>
                        <input type="number" id="adults" value="1" min="1" max="9" class="bg-transparent w-8 text-sm outline-none">
                    </div>
                    <div class="flex items-center gap-2 border-l-2 border-emerald-300 pl-4">
                        <span class="text-[10px]">KIDS</span>
                        <input type="number" id="children" value="0" min="0" max="9" class="bg-transparent w-8 text-sm outline-none">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="relative">
                    <label class="block text-[11px] font-black text-slate-500 mb-2 uppercase tracking-widest">Origin</label>
                    <input type="text" id="from" placeholder="Origin City" class="w-full p-4 bg-slate-100 border-2 border-slate-200 rounded-xl outline-none font-black text-sm" oninput="handleAutocomplete(this)" autocomplete="off">
                    <div class="suggestions bg-white border-2 hidden shadow-2xl rounded-xl mt-2 max-h-48 overflow-y-auto"></div>
                </div>
                <div class="relative">
                    <label class="block text-[11px] font-black text-slate-500 mb-2 uppercase tracking-widest">Destination</label>
                    <input type="text" id="to" placeholder="Destination City" class="w-full p-4 bg-slate-100 border-2 border-slate-200 rounded-xl outline-none font-black text-sm" oninput="handleAutocomplete(this)" autocomplete="off">
                    <div class="suggestions bg-white border-2 hidden shadow-2xl rounded-xl mt-2 max-h-48 overflow-y-auto"></div>
                </div>
                <div><label class="block text-[11px] font-black text-slate-500 mb-2 uppercase tracking-widest">Depart</label><input type="date" id="depDate" class="w-full p-4 bg-slate-100 border-2 border-slate-200 rounded-xl font-black text-sm"></div>
                <div id="retDateContainer" class="hidden"><label class="block text-[11px] font-black text-slate-500 mb-2 uppercase tracking-widest">Return</label><input type="date" id="retDate" class="w-full p-4 bg-slate-100 border-2 border-slate-200 rounded-xl font-black text-sm"></div>
            </div>
            <button onclick="startSearch()" class="w-full mt-10 btn-accent-solid text-white font-black py-5 rounded-2xl shadow-lg transition-all uppercase tracking-widest text-sm relative top-0 hover:-top-1">Search Live Flights</button>
        </div>

        <div id="results" class="space-y-6 pb-20"></div>
    </div>

    <div id="bookingModal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[3rem] p-12 max-w-2xl w-full shadow-2xl relative fade-in border-4 border-slate-100 overflow-y-auto max-h-[90vh]">
            <button onclick="closeBooking()" class="absolute top-8 right-8 text-slate-400 hover:text-red-500 transition-colors text-3xl"><i class="fa-solid fa-circle-xmark"></i></button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
       // CRITICAL: Must use HTTPS and no trailing slash
const BACKEND_URL = 'https://flightfinder-backend-z4dq.onrender.com';

async function handleAutocomplete(input) {
    const query = input.value; 
    const suggestions = input.nextElementSibling;
    if (query.length < 2) return suggestions.classList.add('hidden');

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
        try {
            // FIXED: Full URL construction for cloud hosting
            const res = await fetch(`${BACKEND_URL}/autocomplete?keyword=${query}`);
            const data = await res.json();
            
            suggestions.innerHTML = ''; 
            suggestions.classList.remove('hidden');
            
            data.forEach(loc => {
                const d = document.createElement('div');
                d.className = "p-4 hover:bg-slate-100 cursor-pointer text-xs font-bold border-b text-slate-700";
                d.innerHTML = `<span class="text-blue-600 font-black mr-2">${loc.iataCode}</span> ${loc.name}`;
                d.onclick = () => { 
                    input.value = loc.iataCode; 
                    suggestions.classList.add('hidden'); 
                };
                suggestions.appendChild(d);
            });
        } catch(e) { 
            console.error("Autocomplete fetch failed:", e);
            suggestions.classList.add('hidden'); 
        }
    }, 300);
}

        async function startSearch() {
            const from = document.getElementById('from').value, to = document.getElementById('to').value, dep = document.getElementById('depDate').value, curr = document.getElementById('currency')?.value || 'USD', ad = document.getElementById('adults').value, ch = document.getElementById('children').value;
            if(!to || !from || !dep) return alert("Please select airports and dates.");
            
            document.getElementById('results').innerHTML = '<div class="text-center py-20"><i class="fas fa-circle-notch fa-spin fa-3x text-blue-600"></i></div>';
            
            try {
                const res = await fetch(`${BACKEND_URL}/search-flights?origin=${from}&destination=${to}&date=${dep}&currency=${curr}&adults=${ad}&children=${ch}`);
                const data = await res.json();
                outboundOffers = data.data || [];
                airlineMap = { ...airlineMap, ...data.dictionaries?.carriers }; 
                aircraftMap = { ...aircraftMap, ...data.dictionaries?.aircraft }; 
                sortAndRender();
            } catch (err) { 
                alert("Search failed. Ensure your backend server is live."); 
                document.getElementById('results').innerHTML = '';
            }
        }

        function sortAndRender() {
            const div = document.getElementById('results'), offers = outboundOffers;
            div.innerHTML = '';
            
            if (offers.length === 0) {
                div.innerHTML = `<div class="bg-white p-16 rounded-[3rem] shadow-xl border-2 border-slate-100 text-center fade-in mt-10"><h2 class="text-3xl font-black mb-4 uppercase text-slate-800">No Flights Found</h2><p class="text-slate-500 font-bold">Try a different route or date.</p></div>`;
                return;
            }

            offers.forEach((f, i) => {
                const it = f.itineraries[0], code = f.validatingAirlineCodes[0], encodedData = btoa(JSON.stringify(f));
                let segHTML = '';
                it.segments.forEach(seg => {
                    segHTML += `<div class="bg-slate-50 p-6 rounded-2xl mb-4 font-black text-sm">${formatTime(seg.departure.at.split('T')[1].substring(0,5))} ${seg.departure.iataCode} â†’ ${airlineMap[seg.carrierCode] || seg.carrierCode}</div>`;
                });
                
                const card = document.createElement('div');
                card.className = "bg-white p-10 rounded-[2.5rem] shadow-lg border-2 border-slate-100 mb-6";
                card.innerHTML = `<div class="flex justify-between items-center"><div class="flex gap-6 items-center"><img src="https://pics.avs.io/200/200/${code}.png" class="w-16 h-16 border rounded-xl" onerror="this.src='https://www.gstatic.com/flights/airline_logos/70px/default.png'"><div><div class="text-2xl font-black">${airlineMap[code] || code}</div><div class="text-xs text-slate-400 uppercase font-black">${it.segments.length-1 === 0 ? 'Direct' : it.segments.length-1 + ' Stop'}</div></div></div><div class="text-right"><div class="text-4xl font-black text-emerald-600 mb-3">$${f.price.total}</div><button onclick="handleSelection('${encodedData}')" class="btn-accent-solid px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg">Select Flight</button></div></div>`;
                div.appendChild(card);
            });
        }

        function handleSelection(encoded) {
            const selection = JSON.parse(atob(encoded));
            showSummary(selection);
        }

        function showSummary(f) {
            document.getElementById('modalContent').innerHTML = `<h2 class="text-4xl font-black mb-8 text-center uppercase">Confirm Booking</h2><div class="bg-slate-50 p-10 rounded-[3rem] border-2 border-slate-200 mb-10 text-center"><div class="text-6xl font-black text-emerald-600">$${f.price.total}</div><p class="text-[10px] font-black text-slate-400 mt-4 uppercase">Direct transfer to secure airline portal</p></div><button onclick='redirectToAirline(${JSON.stringify(f)})' class="btn-brand-solid text-white w-full py-6 rounded-3xl font-black uppercase shadow-2xl">Continue to Airline</button>`;
            document.getElementById('bookingModal').classList.remove('hidden'); document.getElementById('bookingModal').classList.add('flex');
        }

        // REDIRECTION ENGINE - FIXED FOR TAP 404s
        function redirectToAirline(f) {
            const c = f.validatingAirlineCodes[0], from = f.itineraries[0].segments[0].departure.iataCode, to = f.itineraries[0].segments.slice(-1)[0].arrival.iataCode, dep = f.itineraries[0].segments[0].departure.at.split('T')[0], ad = document.getElementById('adults').value;
            
            const links = {
                'TP': `https://www.flytap.com/en-us/book-flights?origin=${from}&destination=${to}&departureDate=${dep}&adults=${ad}`,
                'UA': `https://www.united.com/en/us/fly/booking/flights?f=${from}&t=${to}&d=${dep}&px=${ad}`,
                'B6': `https://www.jetblue.com/booking/flights?from=${from}&to=${to}&depart=${dep}&adults=${ad}`,
                'AA': `https://www.aa.com/booking/flights/choose-flights/query?origin=${from}&destination=${to}&departureDate=${dep}&adultCount=${ad}`
            };

            const finalUrl = links[c] || `https://www.google.com/flights?hl=en#flt=${from}.${to}.${dep}`;
            window.open(finalUrl, '_blank');
            closeBooking();
        }

        function closeBooking() { document.getElementById('bookingModal').classList.add('hidden'); }
        function loadFeaturedDeals() {} // Placeholder for trending logic
    </script>
</body>
</html>